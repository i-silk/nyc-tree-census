<!-- Code adapted from http://bl.ocks.org/phil-pedruco/6646844,
http://bl.ocks.org/KoGor/5685876,
https://bl.ocks.org/mbostock/4060606
json file downloaded from
http://nycdata.pediacities.com/dataset/nyc-borough-boundaries-->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title Borough Densities></title>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>

    <style>
      .boroughs {
        stroke: darkgray;
      	stroke-width: 1px;
      }

      .title {
        font: 14.5pt sans-serif;
        font-weight: bold;
        text-anchor: middle;
      }

      .subtitle {
        font: 11pt sans-serif;
        opacity: 0.65;
        text-anchor: middle;
      }

      .notebar text {
        fill: silver;
        font: 10pt sans-serif;
        text-anchor: middle;
      }

      .legend {
        font-size: 10pt;
      }

      div.tooltip {
        position: absolute;
        text-align: center;
        font-size: 10pt;
        width: 150px;
        height: 30px;
        padding: 3px;
        background: #f2f7ef;
        border-radius: 3px;
        pointer-events: none;
      }

    </style>
  </head>

  <body>
    <script>

      var outerWidth = 550;
      var outerHeight = 500;
      var titleY = 20;
      var subtitleY = 43;
      var noteY = 45;
      var margin = { left: 0, top: 100, right: 0, bottom: 100 };

      var innerWidth  = outerWidth  - margin.left - margin.right;
      var innerHeight = outerHeight - margin.top  - margin.bottom;

      var mapScale = innerHeight * 130;

      var color_domain = [1200, 1400, 1600, 1800, 2000, 2200, 2400, 2600, 2800,
                          3000]
      var legend_labels = ["1400", "1600", "1800", "2000", "2200",
                           "2400" , "2600", "2800"]

      var color = d3.scale.threshold()
        .domain(color_domain)
        .range(['#f9f9ea', '#ffffe5', '#f7fcb9', '#d9f0a3', '#addd8e', '#78c679',
                '#41ab5d', '#238443', '#006837', '#004529']);

      var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0.0);

      var svg = d3.select("body").append("svg")
          .attr("width", outerWidth)
          .attr("height", outerHeight);

      var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var projection = d3.geo.mercator()
				.center([-73.94, 40.70])
				.scale(mapScale)
				.translate([innerWidth/2, innerHeight/2]);

    	var path = d3.geo.path()
    			.projection(projection);

      //Reading map file and data
      queue()
        .defer(d3.json, "boroughs.json")
        .defer(d3.csv, "processed-data/alive_tree_borough_densities.csv")
        .await(ready);

      //Start of map drawing
      function ready(error, map, data) {
        var name = {};
        var count = {};
        var density = {};

        data.forEach(function(d) {
          name[d.borough] = d.borough;
          count[d.borough] =  +d.count_15;
          density[d.borough] = +d.density_15;
        });

      	g.append("g")
      		.attr("class", "boroughs")
      		.selectAll(".path")
          .data(map.features)
      		.enter().append("path")
      		.attr("d", path)
          .style("fill", function(d) {
            return color(density[d.properties.borough]);
          })

        //Adding mouse events
        .on("mouseover", function(d) {
          d3.select(this).style("fill", "#80cdc1");
          div.transition()
             .duration(200)
             .style("opacity", 1.0);
          div.html("<b>" + name[d.properties.borough] + ": " +
                   density[d.properties.borough] + "</b> trees per sq mi; " +
                   d3.format(",")(count[d.properties.borough]) + " trees")
             .style("left", (d3.event.pageX) + "px")
             .style("top", (d3.event.pageY -30) + "px");
        })
        .on("mouseout", function(d) {
          d3.select(this).style("fill", function(d) {
            return color(density[d.properties.borough]);
          })
          div.transition()
             .duration(200)
             .style("opacity", 0.0);
        })

      }; //<---- End of map drawing

      var titlesBox = svg.append("g")
      var title = titlesBox.append("text")
        .attr("class", "title")
        .attr("y", titleY)
        .attr("x", outerWidth / 2)
        .text("Street Tree Densities per Borough");
      var description = titlesBox.append("text")
        .attr("class", "subtitle")
        .attr("y", subtitleY)
        .attr("x", outerWidth / 2)
        .text("Queens has given up the title of the 'Greenest Streets' to Manhattan.");

      var noteBar = svg.append("g")
        .attr("class", "notebar");
      var note = noteBar.append("text")
        .attr("y", outerHeight - noteY)
        .attr("dy", 0.5)
        .attr("x", outerWidth / 2)
        .text("Methodology: The land areas of 10 biggest parks as well as the \
               areas of LaGuardia and JFK airports were subtracted from the \
               land areas of the boroughs, since only street treets were counted.")
        .call(wrap, innerWidth);

      function wrap(text, width) {
        text.each(function() {
          var text = d3.select(this),
              words = text.text().split(/\s+/).reverse(),
              word,
              line = [],
              lineNumber = 0,
              lineHeight = 1.1, // ems
              y = text.attr("y"),
              x = text.attr("x"),
              dy = parseFloat(text.attr("dy")),
              tspan = text.text(null).append("tspan")
                                     .attr("x", x)
                                     .attr("y", y).attr("dy", dy + "em");
          while (word = words.pop()) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > width) {
              line.pop();
              tspan.text(line.join(" "));
              line = [word];
              tspan = text.append("tspan")
                          .attr("x", x).attr("y", y)
                          .attr("dy", ++lineNumber * lineHeight + dy + "em")
                          .text(word);
            }
          }
        });
      }

    </script>
  </body>
</html>
